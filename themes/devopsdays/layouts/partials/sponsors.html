{{ if .Site.Data.sponsors }}
{{- /* Build a map of level to package name and group levels by group name */ -}}
{{- $levelToName := dict -}}
{{- $groupedLevels := dict -}}
{{- range .Site.Data.sponsor_packages.packages -}}
{{- $levelToName = merge $levelToName (dict .level .name) -}}
{{- if .group -}}
{{- $existingLevels := index $groupedLevels .group | default slice -}}
{{- $groupedLevels = merge $groupedLevels (dict .group ($existingLevels | append .level)) -}}
{{- end -}}
{{- end -}}

{{- /* Track which levels have been displayed to avoid duplicates */ -}}
{{- $displayedLevels := slice -}}

<section class="py-8 bg-white">
    <div class="container mx-auto px-4">
        <h3 class="text-2xl font-bold text-center mb-8" style="color: var(--indigo-dye);">Our Amazing Sponsors</h3>

        <!-- Gold Sponsors -->
        {{ $gold := where .Site.Data.sponsors.sponsors "level" "gold" }}
        {{ if $gold }}
        {{- $packageName := index $levelToName "gold" | default "Gold" -}}
        <div class="mb-8">
            <h4 class="text-xl font-semibold text-center mb-6" style="color: var(--indigo-dye);">{{ $packageName }}</h4>
            <div class="flex flex-wrap justify-center items-center gap-8" data-sponsor-tier="gold">
                {{ range $gold }}
                <a href="{{ .website }}" target="_blank" rel="noopener" class="block sponsor-logo-container">
                    <img src="{{ .logo }}" alt="{{ .name }}"
                        class="sponsor-logo sponsor-logo-gold opacity-75 hover:opacity-100 transition-opacity">
                </a>
                {{ end }}
            </div>
        </div>
        {{ end }}

        <!-- Silver Sponsors -->
        {{ $silver := where .Site.Data.sponsors.sponsors "level" "silver" }}
        {{ if $silver }}
        {{- $packageName := index $levelToName "silver" | default "Silver" -}}
        <div class="mb-8">
            <h4 class="text-lg font-semibold text-center mb-6" style="color: var(--indigo-dye);">{{ $packageName }}</h4>
            <div class="flex flex-wrap justify-center items-center gap-6" data-sponsor-tier="silver">
                {{ range $silver }}
                <a href="{{ .website }}" target="_blank" rel="noopener" class="block sponsor-logo-container">
                    <img src="{{ .logo }}" alt="{{ .name }}"
                        class="sponsor-logo sponsor-logo-silver opacity-75 hover:opacity-100 transition-opacity">
                </a>
                {{ end }}
            </div>
        </div>
        {{ end }}

        <!-- Grouped Sponsors (dynamically rendered from sponsor_packages.json) -->
        {{- range $groupName, $levels := $groupedLevels -}}
        {{- $hasSponsors := false -}}
        {{- $groupSponsors := slice -}}
        {{- range $levels -}}
        {{- $levelSponsors := where $.Site.Data.sponsors.sponsors "level" . -}}
        {{- if $levelSponsors -}}
        {{- $hasSponsors = true -}}
        {{- end -}}
        {{- end -}}
        {{ if $hasSponsors }}
        <div class="mb-8">
            <h4 class="text-lg font-semibold text-center mb-6" style="color: var(--indigo-dye);">{{ $groupName }}</h4>
            <div class="flex flex-wrap justify-center items-center gap-6" data-sponsor-tier="event">
                {{- range $levels -}}
                {{- $levelSponsors := where $.Site.Data.sponsors.sponsors "level" . -}}
                {{ range $levelSponsors }}
                <a href="{{ .website }}" target="_blank" rel="noopener" class="block sponsor-logo-container">
                    <img src="{{ .logo }}" alt="{{ .name }}"
                        class="sponsor-logo sponsor-logo-event opacity-75 hover:opacity-100 transition-opacity">
                </a>
                {{ end }}
                {{- end -}}
            </div>
        </div>
        {{- $displayedLevels = $displayedLevels | append $levels -}}
        {{ end }}
        {{- end -}}

        <!-- Bronze Sponsors -->
        {{ $bronze := where .Site.Data.sponsors.sponsors "level" "bronze" }}
        {{ if $bronze }}
        {{- $packageName := index $levelToName "bronze" | default "Bronze" -}}
        <div class="mb-8">
            <h4 class="text-base font-semibold text-center mb-6" style="color: var(--indigo-dye);">{{ $packageName }}
            </h4>
            <div class="flex flex-wrap justify-center items-center" data-sponsor-tier="bronze">
                {{ range $bronze }}
                <a href="{{ .website }}" target="_blank" rel="noopener" class="block sponsor-logo-container">
                    <img src="{{ .logo }}" alt="{{ .name }}"
                        class="sponsor-logo sponsor-logo-bronze opacity-75 hover:opacity-100 transition-opacity">
                </a>
                {{ end }}
            </div>
        </div>
        {{ end }}

        <!-- Community Sponsors -->
        {{ $community := where .Site.Data.sponsors.sponsors "level" "community" }}
        {{ if $community }}
        {{- $packageName := index $levelToName "community" | default "Community" -}}
        <div class="mb-8">
            <h4 class="text-base font-semibold text-center mb-6" style="color: var(--indigo-dye);">{{ $packageName }}
            </h4>
            <div class="flex flex-wrap justify-center items-center gap-4" data-sponsor-tier="community">
                {{ range $community }}
                <a href="{{ .website }}" target="_blank" rel="noopener" class="block sponsor-logo-container">
                    <img src="{{ .logo }}" alt="{{ .name }}"
                        class="sponsor-logo sponsor-logo-community opacity-75 hover:opacity-100 transition-opacity">
                </a>
                {{ end }}
            </div>
        </div>
        {{ end }}

        <!-- Partner Sponsors -->
        {{ $partner := where .Site.Data.sponsors.sponsors "level" "partner" }}
        {{ if $partner }}
        {{- $packageName := index $levelToName "partner" | default "Partner" -}}
        <div class="mb-6">
            <h4 class="text-base font-semibold text-center mb-6" style="color: var(--indigo-dye);">{{ $packageName }}
            </h4>
            <div class="flex flex-wrap justify-center items-center gap-4" data-sponsor-tier="partner">
                {{ range $partner }}
                <a href="{{ .website }}" target="_blank" rel="noopener" class="block sponsor-logo-container">
                    <img src="{{ .logo }}" alt="{{ .name }}"
                        class="sponsor-logo sponsor-logo-bronze opacity-75 hover:opacity-100 transition-opacity">
                </a>
                {{ end }}
            </div>
        </div>
        {{ end }}

        <div class="text-center mt-8">
            <a href="/event/sponsors/" class="text-base font-semibold" style="color: var(--cerulean);"
                onmouseover="this.style.color='var(--indigo-dye)'" onmouseout="this.style.color='var(--cerulean)'">
                Learn more about sponsoring this event â†’
            </a>
        </div>
    </div>
</section>

<script>
    // Calculate optimal row height based on widest logo
    function adjustSponsorLogoHeights() {
        const tiers = document.querySelectorAll('[data-sponsor-tier]');

        tiers.forEach(tierContainer => {
            const tier = tierContainer.getAttribute('data-sponsor-tier');
            const logos = tierContainer.querySelectorAll('.sponsor-logo');

            if (logos.length === 0) return;

            // Get max-width for this tier from CSS
            const maxWidths = {
                'gold': 180,
                'silver': 150,
                'event': 150,
                'coffee': 150,
                'bronze': 120,
                'community': 110,
                'partner': 120
            };

            const maxWidth = maxWidths[tier] || 150;
            let maxHeight = 0;

            // Calculate the height needed for the widest logo
            logos.forEach(img => {
                if (img.complete && img.naturalWidth > 0) {
                    const aspectRatio = img.naturalHeight / img.naturalWidth;
                    const calculatedHeight = maxWidth * aspectRatio;
                    maxHeight = Math.max(maxHeight, calculatedHeight);
                }
            });

            // Apply the calculated height to all logos in this tier
            if (maxHeight > 0) {
                logos.forEach(img => {
                    img.style.height = maxHeight + 'px';
                });
            }
        });
    }

    // Run on load and when images are loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', adjustSponsorLogoHeights);
    } else {
        adjustSponsorLogoHeights();
    }

    // Also run when window is resized
    window.addEventListener('resize', adjustSponsorLogoHeights);

    // Ensure all images are loaded before calculating
    window.addEventListener('load', adjustSponsorLogoHeights);
</script>
{{ end }}