{{ if .Site.Data.sponsors }}
{{- /* Build a map of level to package name and group levels by group ID */ -}}
{{- $levelToName := dict -}}
{{- $groupedLevels := dict -}}
{{- $groupIdToName := dict -}}
{{- $levelToGroup := dict -}}

{{- /* Build group ID to name mapping */ -}}
{{- range .Site.Data.sponsor_packages.groups -}}
{{- $groupIdToName = merge $groupIdToName (dict .id .name) -}}
{{- end -}}

{{- /* Build level mappings and group levels */ -}}
{{- range .Site.Data.sponsor_packages.packages -}}
{{- $levelToName = merge $levelToName (dict .level .name) -}}
{{- if .group -}}
{{- $existingLevels := index $groupedLevels .group | default slice -}}
{{- $groupedLevels = merge $groupedLevels (dict .group ($existingLevels | append .level)) -}}
{{- $levelToGroup = merge $levelToGroup (dict .level .group) -}}
{{- end -}}
{{- end -}}

<section class="py-8 bg-white">
    <div class="container mx-auto px-4">
        <h3 class="text-2xl font-bold text-center mb-8" style="color: var(--indigo-dye);">Our Amazing Sponsors</h3>

        {{- /* Track which levels and groups have been displayed */ -}}
        {{- $displayedGroups := slice -}}
        {{- $displayedLevels := slice -}}

        {{- /* Iterate through groups array in order */ -}}
        {{- range .Site.Data.sponsor_packages.groups -}}
        {{- $groupId := .id -}}
        {{- $groupName := .name -}}

        {{- /* Check if this is a group */ -}}
        {{- $isGroup := index $groupedLevels $groupId -}}
        {{- if $isGroup -}}
        {{- /* It's a group - display all levels in this group */ -}}
        {{- if not (in $displayedGroups $groupId) -}}
        {{- $displayedGroups = $displayedGroups | append $groupId -}}
        {{- $hasSponsors := false -}}
        {{- range $isGroup -}}
        {{- $levelSponsors := where $.Site.Data.sponsors.sponsors "level" . -}}
        {{- if $levelSponsors -}}
        {{- $hasSponsors = true -}}
        {{- end -}}
        {{- end -}}

        {{ if $hasSponsors }}
        <div class="mb-8">
            <h4 class="text-lg font-semibold text-center mb-6" style="color: var(--indigo-dye);">{{ $groupName }}
            </h4>
            <div class="flex flex-wrap justify-center items-center gap-6" data-sponsor-tier="{{ index $isGroup 0 }}">
                {{- range $isGroup -}}
                {{- $displayedLevels = $displayedLevels | append . -}}
                {{- $currentLevel := . -}}
                {{- $levelSponsors := where $.Site.Data.sponsors.sponsors "level" . -}}
                {{ range $levelSponsors }}
                <a href="{{ .website }}" target="_blank" rel="noopener" class="block sponsor-logo-container">
                    <img src="{{ .logo }}" alt="{{ .name }}"
                        class="sponsor-logo sponsor-logo-{{ $currentLevel }} opacity-75 hover:opacity-100 transition-opacity">
                </a>
                {{ end }}
                {{- end -}}
            </div>
        </div>
        {{ end }}
        {{- end -}}
        {{- else -}}
        {{- /* It's an individual level ID - find the level */ -}}
        {{- range $.Site.Data.sponsor_packages.packages -}}
        {{- if eq .level $groupId -}}
        {{- $level := .level -}}
        {{- if not (in $displayedLevels $level) -}}
        {{- $displayedLevels = $displayedLevels | append $level -}}
        {{- $levelSponsors := where $.Site.Data.sponsors.sponsors "level" $level -}}
        {{ if $levelSponsors }}
        <div class="mb-8">
            <h4 class="text-lg font-semibold text-center mb-6" style="color: var(--indigo-dye);">{{ $groupName }}</h4>
            <div class="flex flex-wrap justify-center items-center gap-6" data-sponsor-tier="{{ $level }}">
                {{ range $levelSponsors }}
                <a href="{{ .website }}" target="_blank" rel="noopener" class="block sponsor-logo-container">
                    <img src="{{ .logo }}" alt="{{ .name }}"
                        class="sponsor-logo sponsor-logo-{{ $level }} opacity-75 hover:opacity-100 transition-opacity">
                </a>
                {{ end }}
            </div>
        </div>
        {{ end }}
        {{- end -}}
        {{- end -}}
        {{- end -}}
        {{- end -}}
        {{- end -}}

        <div class="text-center mt-8">
            <a href="/event/sponsors/" class="text-base font-semibold" style="color: var(--cerulean);"
                onmouseover="this.style.color='var(--indigo-dye)'" onmouseout="this.style.color='var(--cerulean)'">
                Learn more about sponsoring this event â†’
            </a>
        </div>
    </div>
</section>

<script>
    // Calculate optimal row height based on widest logo
    function adjustSponsorLogoHeights() {
        const tiers = document.querySelectorAll('[data-sponsor-tier]');

        tiers.forEach(tierContainer => {
            const tier = tierContainer.getAttribute('data-sponsor-tier');
            const logos = tierContainer.querySelectorAll('.sponsor-logo');

            if (logos.length === 0) return;

            // Get max-width for this tier from CSS
            const maxWidths = {
                'gold': 180,
                'silver': 150,
                'event': 150,
                'coffee': 150,
                'bronze': 120,
                'community': 110,
                'partner': 120
            };

            const maxWidth = maxWidths[tier] || 150;
            let maxHeight = 0;

            // Calculate the height needed for the widest logo
            logos.forEach(img => {
                if (img.complete && img.naturalWidth > 0) {
                    const aspectRatio = img.naturalHeight / img.naturalWidth;
                    const calculatedHeight = maxWidth * aspectRatio;
                    maxHeight = Math.max(maxHeight, calculatedHeight);
                }
            });

            // Apply the calculated height to all logos in this tier
            if (maxHeight > 0) {
                logos.forEach(img => {
                    img.style.height = maxHeight + 'px';
                });
            }
        });
    }

    // Run on load and when images are loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', adjustSponsorLogoHeights);
    } else {
        adjustSponsorLogoHeights();
    }

    // Also run when window is resized
    window.addEventListener('resize', adjustSponsorLogoHeights);

    // Ensure all images are loaded before calculating
    window.addEventListener('load', adjustSponsorLogoHeights);
</script>
{{ end }}