name: Cleanup old previews

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # daily at midnight UTC

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old preview deployments
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CF_PROJECT_NAME: devopsdays-ch
          KEEP_LATEST: 5
        run: |
          response=$(curl -s -H "Authorization: Bearer $CF_API_TOKEN" \
            "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/pages/projects/$CF_PROJECT_NAME/deployments")
          
          echo "API Response: $response"
          
          # Check if request was successful
          if ! echo "$response" | jq -e '.success == true' > /dev/null 2>&1; then
            echo "Error: API request failed"
            echo "$response" | jq -r '.errors[]? | .message'
            exit 1
          fi
          
          # Get preview deployments and delete old ones
          deployments=$(echo "$response" | jq -r '.result[]? | select(.environment=="preview") | "\(.id) \(.created_on)"' \
            | sort -k2 -r | tail -n +$((KEEP_LATEST + 1)) | awk '{print $1}')

          if [ -z "$deployments" ]; then
            echo "No old preview deployments to clean up"
            exit 0
          fi

          for id in $deployments; do
            echo "Deleting deployment $id"
            curl -X DELETE -H "Authorization: Bearer $CF_API_TOKEN" \
              "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/pages/projects/$CF_PROJECT_NAME/deployments/$id"
          done
