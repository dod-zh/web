name: Cleanup old previews

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # daily at midnight UTC

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old preview deployments
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CF_PROJECT_NAME: devopsdays-ch
          KEEP_LATEST: 5
        run: |
          response=$(curl -s -H "Authorization: Bearer $CF_API_TOKEN" \
            "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/pages/projects/$CF_PROJECT_NAME/deployments")
          
          echo "API Response: $response"
          
          # Check if request was successful
          if ! echo "$response" | jq -e '.success == true' > /dev/null 2>&1; then
            echo "Error: API request failed"
            echo "$response" | jq -r '.errors[]? | .message'
            exit 1
          fi
          
          # Cleanup old preview deployments
          echo "=== Cleaning up preview deployments ==="
          preview_deployments=$(echo "$response" | jq -r '.result[]? | select(.environment=="preview") | "\(.id) \(.created_on)"' \
            | sort -k2 -r | tail -n +$((KEEP_LATEST + 1)) | awk '{print $1}')

          if [ -z "$preview_deployments" ]; then
            echo "No old preview deployments to clean up"
          else
            for id in $preview_deployments; do
              echo "Deleting preview deployment $id"
              curl -s -X DELETE -H "Authorization: Bearer $CF_API_TOKEN" \
                "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/pages/projects/$CF_PROJECT_NAME/deployments/$id?force=true"
            done
          fi
          
          # Cleanup old production deployments
          echo "=== Cleaning up production deployments ==="
          production_deployments=$(echo "$response" | jq -r '.result[]? | select(.environment=="production") | "\(.id) \(.created_on)"' \
            | sort -k2 -r | tail -n +$((KEEP_LATEST + 1)) | awk '{print $1}')

          if [ -z "$production_deployments" ]; then
            echo "No old production deployments to clean up"
          else
            for id in $production_deployments; do
              echo "Deleting production deployment $id"
              curl -s -X DELETE -H "Authorization: Bearer $CF_API_TOKEN" \
                "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/pages/projects/$CF_PROJECT_NAME/deployments/$id?force=true"
            done
          fi
